# v2.0 - ACP 协议通信改造

> 日期: 2026-01-31  
> 类型: 架构改造  
> 状态: ✅ 已完成

## 概述

将项目从 Claude SDK 直接调用改造为使用 ACP (Agent Client Protocol) 协议与 Claude Code Agent 通信。

## 变更内容

### 新增文件

| 文件 | 说明 |
|------|------|
| `src/main/acp/types.ts` | ACP 协议类型定义 |
| `src/main/acp/ACPClient.ts` | ACP 连接管理 |
| `src/main/acp/ACPSession.ts` | ACP 会话封装 |
| `src/main/acp/index.ts` | 模块导出 |

### 修改文件

| 文件 | 变更 |
|------|------|
| `src/main/managers/SessionManager.ts` | 从管理 ClaudeCodeProcess 改为管理 ACPClient/ACPSession |
| `src/main/managers/ConfigManager.ts` | 新增 `agentCommand` 配置项 |
| `src/main/ipc/handlers.ts` | 使用 session.prompt() 替代 session.sendMessage() |
| `src/main/main.ts` | 初始化 ACP 配置，注入环境变量 |
| `src/types/channels.ts` | 新增 ACP 相关 IPC 通道 |
| `agents.md` | 更新架构文档 |

### IPC 通道变更

新增:
- `ACP_CANCEL` - 取消当前请求
- `ACP_TOOL_CALL` - 工具调用事件
- `ACP_TOOL_CALL_UPDATE` - 工具调用更新
- `ACP_PERMISSION_REQUEST` - 权限请求
- `ACP_PERMISSION_RESPONSE` - 权限响应

移除:
- `CLAUDE_START`
- `CLAUDE_STOP`
- `CLAUDE_INJECT`

## 关键修复

### 1. ACP 初始化参数

需要 `protocolVersion` 参数:

```typescript
await this.sendRequest('initialize', {
  protocolVersion: 1,
  clientInfo: this.config.clientInfo,
  clientCapabilities: { ... },
});
```

### 2. session/new 参数

需要 `cwd` 和 `mcpServers`:

```typescript
await this.sendRequest('session/new', {
  sessionId,
  cwd: this.config.workingDir,
  mcpServers: [],
});
```

### 3. session/update 数据结构解包

实际数据有嵌套的 `update` 字段:

```typescript
const innerUpdate = (update as any).update || update;
const sessionUpdate = innerUpdate.sessionUpdate;
const content = innerUpdate.content;
```

## 依赖

```bash
# 全局安装 ACP 适配器
npm install -g @zed-industries/claude-code-acp
```

## 配置

在 `~/.claude/settings.json` 中配置 API Key:

```json
{
  "env": {
    "ANTHROPIC_API_KEY": "sk-ant-..."
  }
}
```

---

*提交时间: 2026-01-31*
